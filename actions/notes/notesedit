#!/usr/bin/env bash
# shellcheck shell=bash
#===============================================================================
#
#          FILE: notesedit
#
#         USAGE: todo.sh notesedit [NOTESFILE]
#
#        AUTHOR: Paul Mansfield (paul.mansfield@mansteck.co.uk), 
#     COPYRIGHT: 2009-2021 Paul Mansfield
#       LICENSE: GPL, http://www.gnu.org/copyleft/gpl.html
#===============================================================================

usage () {
  echo "    $(basename "$0") [NOTESFILE]"
  echo "      Edit notes file, in \$EDITOR."
  echo "      use listnotes to get list of notes files"
}

die () {
  if [[ -n $* ]]; then
    echo -e "$*"
  fi
  usage
	exit 1
}

# Find editor to use, if EDITOR already set use.
# Else use debian and derivatives editor (alternatives auto set by OS)
# finally if neither EDITOR nor alternative set default to vi
find_editor () {
  if [[ -n ${EDITOR} ]]; then
    true
	elif [[ -L /usr/bin/editor ]]; then
		EDITOR="/usr/bin/editor"
	elif [[ -z "${EDITOR}" ]]; then
		EDITOR="vi"
	fi
  echo "${EDITOR}"
}

# Usage for todo.sh help or remove action
if [[ "${1}" = "usage" ]] || [[ "${2}" = "usage" ]]; then
  usage
  exit
elif [[ "${1}" = "$(basename "$0")" ]]; then
shift
fi

NOTE_FILE="${1/#note:/}"; shift
PRE="$(basename "${TODO_FILE}")"; PRE=${PRE/%\.txt/}
TODO_TMP_FILE="${TODO_TMP_FILE:-${TODO_DIR}/todo.tmp}"
EDITOR=$(find_editor)

if [[ -z "${NOTE_FILE}" ]]; then
  die "      No notes file"
elif [[ $(grep -c "note:${NOTE_FILE}" "${TODO_FILE}") -eq 0 ]]; then
  die "      No such notes file, use listnotes to find notes files"
fi

# Create file from todo and 'tickled' files
cat "${TODO_FILE}" > "${TODO_TMP_FILE}"
if [ -n "${TICKLER_DIR}" ]; then
	find "${TICKLER_DIR}" -mindepth 2 -type f -size 1 -exec cat {} \; >>"${TODO_TMP_FILE}"
fi

# If file exists edit it else check listnotes for pointer then edit 
if [ -e "${TODO_DIR}/notes/${PRE}-${NOTE_FILE}.txt" ]; then
	"${EDITOR}" "${TODO_DIR}/notes/${PRE}-${NOTE_FILE}.txt"
else
	# If note link in todo.txt exists then edit
	# shellcheck disable=SC2046,SC2086
  NUM_ENOTE=$(grep -c "[^ ]*enote:${NOTE_FILE}[^ ]\+" "${TODO_TMP_FILE}")
	if [ "${NUM_ENOTE}" -ge 1 ] ; then
		"${EDITOR}" "${TODO_DIR}/notes/${PRE}-${NOTE_FILE}.txt"
    [[ -f "${TODO_TMP_FILE}" ]] && rm -rf "${TODO_TMP_FILE}"
	fi
fi